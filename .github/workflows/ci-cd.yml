- name: Update GitOps repository
        shell: pwsh                       # Changed to PowerShell for Windows
        env:
          GIT_TOKEN: ${{ secrets.GITOPS_PAT }}
        run: |
          # 1. Configure Git Credentials
          git config --global credential.helper store
          "https://$($env:GIT_TOKEN):x-oauth-basic@github.com" | Out-File -FilePath "$env:USERPROFILE\.git-credentials" -Encoding ASCII
          
          # 2. Clean old directory (Windows safe command)
          if (Test-Path gitops) { Remove-Item -Recurse -Force gitops }
          
          # 3. Clone Repository
          git clone https://github.com/aniketpuro/grade-api-gitops.git gitops
          cd gitops
          
          # 4. Replace Image Tag (PowerShell equivalent of 'sed')
          $fileName = "deployment.yaml"
          $repo = "${{ github.repository }}"
          $sha = "${{ github.sha }}"
          
          # Reading and Replacing content
          $content = Get-Content $fileName
          $newContent = $content -replace "image: ghcr.io/$repo:.*", "image: ghcr.io/$repo:$sha"
          Set-Content -Path $fileName -Value $newContent
          
          # 5. Commit and Push
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add deployment.yaml
          git commit -m "Update image to $sha"
          
          # Push changes
          git push -f https://$($env:GIT_TOKEN)@github.com/aniketpuro/grade-api-gitops.git main
